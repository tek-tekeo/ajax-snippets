<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>アフィリエイトプラグイン</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
</head>

<body>
  <div id="vue-edit-page">
    <v-app>
      <v-main>
        <v-container fluid>
          <wp-search-text-box
            label="名前で検索"
            @search-text="searchText"
          >
          </wp-search-text-box>

          <v-btn
            color="primary"
            @click="itemInfo"
            small
          >
            情報
          </v-btn>

          <v-btn
            color="blue-grey"
            class="ma-2 white--text"
            @click="shohinLink"
            small
          >
            商品カード
          </v-btn>

          <v-btn
            color="success"
            @click="textLink"
            small
          >
            テキストリンク
          </v-btn>

          <v-btn
            color="info"
            @click="bannerLink"
            small
          >
            バナー
          </v-btn>

          <v-btn
            color="blue-grey"
            class="ma-2 white--text"
            @click="singleReview"
            small
          >
            レビューBOX
          </v-btn>

          <v-btn
            color="indigo"
            class="ma-2 white--text"
            @click="appLink"
            small
          >
            アプリ
          </v-btn>
          <v-btn
          @click="quoteLink"
          small
          >
            引用
          </v-btn>
          <v-radio-group v-model="itemNo"> 
            {{itemNo}}
            <v-virtual-scroll
            :items="searchList"
            height="400"
            item-height="40"
            >
            <template v-slot:default="{ item }">
                <v-radio
                  :label="item.name"
                  :value="item.id"
                ></v-radio>
            </template>
          </v-virtual-scroll>
        </v-radio-group>
        </v-container>
      </v-main>
    </v-app>
</body>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
<script src="https://unpkg.com/http-vue-loader"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
<script src="https://unpkg.com/vue-toasted"></script>

<script>
  Vue.use(Toasted);
  axios.defaults.baseURL = 'http://localhost:3000/?rest_route=/ajax_snippets_path/v1/';
  new Vue({
    el: '#vue-edit-page',
    vuetify: new Vuetify(),
    components: {
      'WpSearchTextBox': httpVueLoader('/wp-content/plugins/ajaxSnippets/AdminViews/atoms/wpSearchTextBox.vue')
    },
    data() {
      return {
        searchList:[],
        itemNo:null,
      }
    },
    async created(){
      try {
        const res = await axios.post('/detail/editor',{
          'name':''
        });
        this.searchList = res.data;
      } catch (err) {
        // TODO: エラー処理
        console.log(err);
      }
    },
    methods:{
      async searchText(name){
        try {
        // TODO: URL
        const res = await axios.post('/detail/editor',{
          'name':name
        });
        this.searchList = res.data;
        } catch (err) {
          // TODO: エラー処理
          console.log(err);
        }
      },
      returnItem(){
        const list = JSON.parse(JSON.stringify(this.searchList));
        const item = list.find((s)=>s.id == this.itemNo);
        return item;
      },
      randomNo(){
        return  Math.random().toString(36).slice(-8);
      },
      closeTinymce(input){
        top.tinymce.activeEditor.selection.setContent(input);
        this.itemNo = null;
        top.tinymce.activeEditor.windowManager.close();
        return;
      },
      async itemInfo(){
        const item = this.returnItem();
        const input = JSON.stringify(item);
        this.closeTinymce(input);
      },
      async shohinLink(){
        if(this.itemNo == null){return;}
        const item = this.returnItem();
        const kw = item.name;
        if (item.rakutenId != "") {
          inputTag = "[rakuten2 id=\"" + item.rakutenId + "\" kw=\"" + kw + "\" title=\"" + kw + "\"";
          inputTag = inputTag + " detail_id=" + item.id + " pl=" + this.randomNo() + "]";
        }else if (item.amazonAsin != "") {
          inputTag = "[amazon asin=\"" + item.amazonAsin + "\" kw=\"" + kw + "\" title=\"" + kw + "\"";
          inputTag = inputTag + " btn1_url=\"" + item.affiLink + "\" btn1_text=\"" + item.parent.name + "公式\"]";
        } else {
          return false;
        }
        this.closeTinymce(inputTag);
      },
      async textLink(){
        if(this.itemNo == null){return;}
        const item = this.returnItem();
        console.log(item.affiLink);
        var inputTag = "[afRecord id=" + item.id + " ntab=1 pl=" + this.randomNo() + "]" + item.name + "[/afRecord]";
        this.closeTinymce(inputTag);
      },
      async bannerLink(){
        if(this.itemNo == null){return;}
        const inputTag = "[afRecordBanner id=" + this.itemNo + " ntab=1 pl=" + this.randomNo() + "]";
        this.closeTinymce(inputTag);
      },
      async singleReview(){
        if(this.itemNo == null){return;}
        let inputTag = "[singleReview detail_id=" + this.itemNo + " is_review=0 color='blue']";
        this.closeTinymce(inputTag);
      },
      async appLink(){
        if(this.itemNo == null){return;}
        let inputTag = "[appLinkG detail_id=" + this.itemNo + " re_url=0 noaf=0 text='テキスト']";
        this.closeTinymce(inputTag);
        
      },
      async quoteLink(){
        if(this.itemNo == null){return;}
        const inputTag = "[afLink id=" + this.itemNo + " re_url=1 noaf=1][/afLink]";

        const blockquoteTag = '<blockquote class="ajax-snippets-quote" cite="' + inputTag + '"><div>評価：[star rate="5" max="5" number="1"]</div><div><span class="bold">タイトル</span></div><p class="fz-14px">引用文</p><cite><a href="' + inputTag + '">公式サイト</a></cite></blockquote>';
        this.closeTinymce(blockquoteTag);
      }
    }
  });
</script>

</html>
